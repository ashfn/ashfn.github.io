<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/fc78d7f357de104b-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/7374508bee51fb34.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-03eb770fb92866e8.js"/><script src="/_next/static/chunks/4bd1b696-56116d406dee7a01.js" async=""></script><script src="/_next/static/chunks/517-718b8866552eb64f.js" async=""></script><script src="/_next/static/chunks/main-app-9071301981a55316.js" async=""></script><script src="/_next/static/chunks/app/layout-7bf6758fb5f273d3.js" async=""></script><script src="/_next/static/chunks/606-87b5527f068dfcd7.js" async=""></script><script src="/_next/static/chunks/173-bdc4390233342f3f.js" async=""></script><script src="/_next/static/chunks/app/error-41473be2b1332ec4.js" async=""></script><script src="/_next/static/chunks/5e22fd23-e3b42928b29e9ef2.js" async=""></script><script src="/_next/static/chunks/app/not-found-0ea2b0cea0bef037.js" async=""></script><script src="/_next/static/chunks/126-4575238353f7612a.js" async=""></script><script src="/_next/static/chunks/app/blog/posts/1/page-9dc464f4691392bd.js" async=""></script><script src="/_next/static/chunks/app/global-error-de714b0c9f5b5117.js" async=""></script><meta name="next-size-adjust" content=""/><title>Asher Falcon</title><meta name="description" content="Asher Falcon&#x27;s personal website - Software engineer and student"/><meta name="author" content="Asher Falcon"/><meta name="keywords" content="Asher Falcon,Software Engineer,Student,Developer,Portfolio"/><meta name="creator" content="Asher Falcon"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class=" __className_9696c7 " style="min-height:100vh;background-color:var(--page-bg, #dce3dc)"><div><div class="h-screen bg-ashwhite"><div style="opacity:0"><div class="pb-[20px]"><div style="padding-top:50px" class="relative flex justify-center items-center h-[50px]"><div class="absolute left-0 flex items-center h-full ml-6"><button class="flex items-center justify-center p-0 m-0 bg-transparent border-0 cursor-pointer " aria-label="Go back"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="30" width="30" xmlns="http://www.w3.org/2000/svg"><path d="M427 234.625H167.296l119.702-119.702L256 85 85 256l171 171 29.922-29.924-118.626-119.701H427v-42.75z"></path></svg></button></div><span class="text-xl">docker deployment</span></div><div style="padding-top:30px" class="flex justify-center items-center md:w-[70%] xl:w-[50%] w-[85%] mx-auto"><div><p>Recently I found myself wanting to deploy a docker-compose file to a server. I wanted to automate this process as much as possible, so I decided to write a shell script to do it. This post will go through the process of writing a shell script to deploy a docker-compose file to a server.</p></div></div><div style="padding-top:30px" class="flex flex-col justify-center items-center md:w-[70%] xl:w-[50%] w-[85%] mx-auto"><p>TLDR, if you just want to check out the script and how to use it, you can find it <a class="text-blue-500" target="_blank" rel="noopener noreferrer" href="https://git.asherfalcon.com/asher/compose-deploy">here</a></p><br/><p>As I started deploying more and more services to my server using docker compose, I kept just copying the whole file, sshing into the server, deleting the file and creating a new one, pasting the content. As you can imagine, that got old fast. Realising I was losing an extra minute or two every time I wanted to re-deploy my <b>docker-compose.yml</b> file, I created a simple git repository, and cloned it on both hosts. This meant I could simply push on my laptop and ssh into the server and run git pull, and I would never have to mess around with copying the whole file manually again. </p><br/><p>Now I was still having to ssh in and stop all the containers, pull the repo and then start them again, and I though it would be nice if I could just do this from the terminal in the VSCode editor I used to edit the docker-compose.yml file, so I wrote a simple script which does all of it for me.</p><br/></div><div class="md:w-[70%] xl:w-[50%] w-[85%] mx-auto"><div class="relative text-white"><div style="position:absolute;right:10px;top:10px"><button class="p-2 rounded"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><center><pre style="display:block;overflow-x:auto;padding:1rem;background:#F0F0F0;color:#444;background-color:transparent;border:2px solid #000000;border-radius:8px;width:100%;text-align:left"><code class="language-bash" style="white-space:pre"><span style="color:#1f7199">#!/bin/bash</span><span>
</span>git add .
<span>git commit -m </span><span style="color:#880000">&quot;updated docker-compose.yml&quot;</span><span>
</span>git push
<!-- -->
<span>ssh -o </span><span style="color:#880000">&quot;StrictHostKeyChecking=no&quot;</span><span> -i ssh.key </span><span style="color:#BC6060">$CD_USER</span><span>@</span><span style="color:#BC6060">$CD_HOST</span><span> &lt;&lt; </span><span style="color:#880000">EOF
</span><span style="color:#880000">sudo su
</span><span style="color:#880000">cd $CD_PATH
</span><span style="color:#880000">docker compose down
</span><span style="color:#880000">git pull
</span><span style="color:#880000">docker compose up -d
</span><span style="color:#880000">exit
</span><span style="color:#880000">EOF</span><span>
</span></code></pre></center></div></div><div style="padding-top:30px" class="flex flex-col justify-center items-center md:w-[70%] xl:w-[50%] w-[85%] mx-auto"><p>So what&#x27;s going on here? Firstly we commit and push all the changed files to the repository, this means that the docker-compose.yml and any other files, for example config files for services you may be running, are now on the remote repository.</p><br/><p>Next, it simply connects to the server via ssh, and runs the commands listed. Firstly, stopping the containers so that the docker-compose.yml and any other config files can be updated safely, then pulling the git repo to update the files. Finally restarting the docker compose services, and then exiting so the ssh session closes.</p><br/><p>Now to make the commit history not look like groundhog day, and to add some commit messages, we can use <a class="text-blue-500" target="_blank" rel="noopener noreferrer" href="https://github.com/charmbracelet/gum">Gum</a>, a tool for easily making interactive bash scripts. It works by installing the application onto your system which can then be called inside your bash scripts to invoke user prompts, for example we can use the code below to get a commit message from the user in the terminal and store it as a variable.</p><br/></div><div class="md:w-[70%] xl:w-[50%] w-[85%] mx-auto"><div class="relative text-white"><div style="position:absolute;right:10px;top:10px"><button class="p-2 rounded"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><center><pre style="display:block;overflow-x:auto;padding:1rem;background:#F0F0F0;color:#444;background-color:transparent;border:2px solid #000000;border-radius:8px;width:100%;text-align:left"><code class="language-bash" style="white-space:pre"><span style="color:#1f7199">#!/bin/bash</span><span>
</span><span>message=$(gum input --placeholder </span><span style="color:#880000">&quot;Commit message&quot;</span><span>)
</span>git add .
<span>git commit -m </span><span style="color:#880000">&quot;</span><span style="color:#BC6060">${message}</span><span style="color:#880000">&quot;</span><span>
</span></code></pre></center></div></div><div style="padding-top:30px" class="flex flex-col justify-center items-center md:w-[70%] xl:w-[50%] w-[85%] mx-auto"><p>Finally, putting all the pieces together and adding a quick check to see if gum is installed, and trying to install it if not, we can arrive at the following script:</p><br/></div><div class="md:w-[70%] xl:w-[50%] w-[85%] mx-auto"><div class="relative text-white"><div style="position:absolute;right:10px;top:10px"><button class="p-2 rounded"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></div><center><pre style="display:block;overflow-x:auto;padding:1rem;background:#F0F0F0;color:#444;background-color:transparent;border:2px solid #000000;border-radius:8px;width:100%;text-align:left"><code class="language-bash" style="white-space:pre"><span style="color:#1f7199">#!/bin/bash</span><span>
</span>
<span></span><span style="color:#888888"># A script to redeploy this docker infrastructure using ssh</span><span>
</span>
<span></span><span style="font-weight:bold">if</span><span> [ -f .env ]; </span><span style="font-weight:bold">then</span><span>
</span><span>    </span><span style="color:#397300">source</span><span> .env
</span><span></span><span style="font-weight:bold">else</span><span>
</span><span>    </span><span style="color:#397300">echo</span><span> </span><span style="color:#880000">&quot;.env file not found. Please create it and set the necessary environment variables.&quot;</span><span>
</span><span>    </span><span style="color:#397300">exit</span><span> 1
</span><span></span><span style="font-weight:bold">fi</span><span>
</span>
<span></span><span class="hljs-function" style="color:#880000;font-weight:bold">check_gum</span><span>() {
</span><span>    </span><span style="font-weight:bold">if</span><span> </span><span style="color:#397300">command</span><span> -v gum &amp;&gt; /dev/null; </span><span style="font-weight:bold">then</span><span>
</span><span>        </span><span style="color:#397300">return</span><span> 0
</span><span>    </span><span style="font-weight:bold">else</span><span>
</span><span>        </span><span style="color:#397300">echo</span><span> </span><span style="color:#880000">&quot;Gum not found, installing...&quot;</span><span>
</span><span>        </span><span style="color:#397300">return</span><span> 1
</span><span>    </span><span style="font-weight:bold">fi</span><span>
</span>}
<!-- -->
<span></span><span class="hljs-function" style="color:#880000;font-weight:bold">install_gum</span><span>() {
</span><span>    </span><span style="font-weight:bold">if</span><span> [[ </span><span style="color:#880000">&quot;</span><span style="color:#BC6060">$OSTYPE</span><span style="color:#880000">&quot;</span><span> == </span><span style="color:#880000">&quot;darwin&quot;</span><span>* ]]; </span><span style="font-weight:bold">then</span><span>
</span><span>        /bin/bash -c </span><span style="color:#880000">&quot;</span><span style="color:#444">$(curl -fsSL 
</span><span style="color:#444">https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)</span><span style="color:#880000">&quot;</span><span>
</span>        brew install gum
<span>    </span><span style="font-weight:bold">elif</span><span> [[ -f /etc/os-release ]]; </span><span style="font-weight:bold">then</span><span>
</span><span>        </span><span style="color:#397300">source</span><span> /etc/os-release
</span><span>        </span><span style="font-weight:bold">if</span><span> [[ </span><span style="color:#BC6060">$ID</span><span> == </span><span style="color:#880000">&quot;ubuntu&quot;</span><span> ]] || [[ </span><span style="color:#BC6060">$ID</span><span> == </span><span style="color:#880000">&quot;debian&quot;</span><span> ]]; </span><span style="font-weight:bold">then</span><span>
</span>            sudo apt update
<!-- -->            sudo apt install -y gum
<span>        </span><span style="font-weight:bold">elif</span><span> [[ </span><span style="color:#BC6060">$ID</span><span> == </span><span style="color:#880000">&quot;fedora&quot;</span><span> ]] || [[ </span><span style="color:#BC6060">$ID</span><span> == </span><span style="color:#880000">&quot;centos&quot;</span><span> ]] || [[ </span><span style="color:#BC6060">$ID</span><span> == </span><span style="color:#880000">&quot;rhel&quot;</span><span> ]]; </span><span style="font-weight:bold">then</span><span>
</span>            sudo dnf install -y gum
<span>        </span><span style="font-weight:bold">else</span><span>
</span><span>            </span><span style="color:#397300">echo</span><span> </span><span style="color:#880000">&quot;Unsupported Linux distribution. Please install Gum 
</span><span style="color:#880000">manually.&quot;</span><span>
</span><span>            </span><span style="color:#397300">exit</span><span> 1
</span><span>        </span><span style="font-weight:bold">fi</span><span>
</span><span>    </span><span style="font-weight:bold">else</span><span>
</span><span>        </span><span style="color:#397300">echo</span><span> </span><span style="color:#880000">&quot;Unsupported operating system. Please install Gum manually.&quot;</span><span>
</span><span>        </span><span style="color:#397300">exit</span><span> 1
</span><span>    </span><span style="font-weight:bold">fi</span><span>
</span>}
<!-- -->
<span></span><span style="color:#888888"># Main script execution</span><span>
</span><span></span><span style="font-weight:bold">if</span><span> ! check_gum; </span><span style="font-weight:bold">then</span><span>
</span><span>    </span><span style="font-weight:bold">if</span><span> ! install_gum; </span><span style="font-weight:bold">then</span><span>
</span><span>        </span><span style="color:#397300">echo</span><span> </span><span style="color:#880000">&quot;Failed to install Gum. Please install it manually and run 
</span><span style="color:#880000">the script again.&quot;</span><span>
</span><span>        </span><span style="color:#397300">exit</span><span> 1
</span><span>    </span><span style="font-weight:bold">fi</span><span>
</span><span></span><span style="font-weight:bold">fi</span><span>
</span>
<span>message=$(gum input --placeholder </span><span style="color:#880000">&quot;Commit message&quot;</span><span>)
</span>
<!-- -->git add .
<span>git commit -m </span><span style="color:#880000">&quot;</span><span style="color:#BC6060">${message}</span><span style="color:#880000">&quot;</span><span>
</span>git push
<!-- -->
<span>ssh -o </span><span style="color:#880000">&quot;StrictHostKeyChecking=no&quot;</span><span> -i ssh.key </span><span style="color:#BC6060">$CD_USER</span><span>@</span><span style="color:#BC6060">$CD_HOST</span><span> &lt;&lt; </span><span style="color:#880000">EOF
</span><span style="color:#880000">sudo su
</span><span style="color:#880000">cd $CD_PATH
</span><span style="color:#880000">docker compose down
</span><span style="color:#880000">git pull
</span><span style="color:#880000">docker compose up -d
</span><span style="color:#880000">exit
</span><span style="color:#880000">EOF</span></code></pre></center></div></div></div></div></div></div><script defer="" src="https://cloud.umami.is/script.js" data-website-id="eaac838f-0bef-4455-a834-2e1455d78d8c"></script><script src="/_next/static/chunks/webpack-03eb770fb92866e8.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[47141,[\"177\",\"static/chunks/app/layout-7bf6758fb5f273d3.js\"],\"default\"]\n3:I[15244,[],\"\"]\n4:I[16310,[\"606\",\"static/chunks/606-87b5527f068dfcd7.js\",\"173\",\"static/chunks/173-bdc4390233342f3f.js\",\"39\",\"static/chunks/app/error-41473be2b1332ec4.js\"],\"default\"]\n5:I[43866,[],\"\"]\n6:I[85408,[\"206\",\"static/chunks/5e22fd23-e3b42928b29e9ef2.js\",\"606\",\"static/chunks/606-87b5527f068dfcd7.js\",\"173\",\"static/chunks/173-bdc4390233342f3f.js\",\"345\",\"static/chunks/app/not-found-0ea2b0cea0bef037.js\"],\"default\"]\n7:I[57033,[],\"ClientPageRoot\"]\n8:I[46766,[\"206\",\"static/chunks/5e22fd23-e3b42928b29e9ef2.js\",\"606\",\"static/chunks/606-87b5527f068dfcd7.js\",\"173\",\"static/chunks/173-bdc4390233342f3f.js\",\"126\",\"static/chunks/126-4575238353f7612a.js\",\"963\",\"static/chunks/app/blog/posts/1/page-9dc464f4691392bd.js\"],\"default\"]\nb:I[86213,[],\"OutletBoundary\"]\nd:I[86213,[],\"MetadataBoundary\"]\nf:I[86213,[],\"ViewportBoundary\"]\n11:I[94788,[\"173\",\"static/chunks/173-bdc4390233342f3f.js\",\"219\",\"static/chunks/app/global-error-de714b0c9f5b5117.js\"],\"default\"]\n:HL[\"/_next/static/media/fc78d7f357de104b-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/css/7374508bee51fb34.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"AmzhgVnv-gEu_dPxiqjBx\",\"p\":\"\",\"c\":[\"\",\"blog\",\"posts\",\"1\",\"\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"blog\",{\"children\":[\"posts\",{\"children\":[\"1\",{\"children\":[\"__PAGE__\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/7374508bee51fb34.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\" __className_9696c7 \",\"style\":{\"minHeight\":\"100vh\",\"backgroundColor\":\"var(--page-bg, #dce3dc)\"},\"children\":[[\"$\",\"$L2\",null,{\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$4\",\"errorStyles\":[],\"errorScripts\":[],\"template\":[\"$\",\"$L5\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[],[\"$\",\"$L6\",null,{}]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}],[\"$\",\"script\",null,{\"defer\":true,\"src\":\"https://cloud.umami.is/script.js\",\"data-website-id\":\"eaac838f-0bef-4455-a834-2e1455d78d8c\"}]]}]}]]}],{\"children\":[\"blog\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L5\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"posts\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"posts\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L5\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"1\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"posts\",\"children\",\"1\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L5\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[[\"$\",\"$L7\",null,{\"Component\":\"$8\",\"searchParams\":{},\"params\":{},\"promises\":[\"$@9\",\"$@a\"]}],null,[\"$\",\"$Lb\",null,{\"children\":\"$Lc\"}]]}],{},null,false]},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"8MfkMw1Gy0sfwPvCMWIai\",{\"children\":[[\"$\",\"$Ld\",null,{\"children\":\"$Le\"}],[\"$\",\"$Lf\",null,{\"children\":\"$L10\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$11\",[]],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"9:{}\na:{}\n"])</script><script>self.__next_f.push([1,"10:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\ne:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Asher Falcon\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Asher Falcon's personal website - Software engineer and student\"}],[\"$\",\"meta\",\"3\",{\"name\":\"author\",\"content\":\"Asher Falcon\"}],[\"$\",\"meta\",\"4\",{\"name\":\"keywords\",\"content\":\"Asher Falcon,Software Engineer,Student,Developer,Portfolio\"}],[\"$\",\"meta\",\"5\",{\"name\":\"creator\",\"content\":\"Asher Falcon\"}],[\"$\",\"link\",\"6\",{\"rel\":\"alternate\",\"type\":\"application/rss+xml\",\"href\":\"/rss.xml\"}]]\n"])</script><script>self.__next_f.push([1,"c:null\n"])</script></body></html>