(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[963],{77379:(e,t,n)=>{Promise.resolve().then(n.bind(n,46766))},46766:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>h});var s=n(95155);let i="docker deployment",o="Recently I found myself wanting to deploy a docker-compose file to a server. I wanted to automate this process as much as possible, so I decided to write a shell script to do it. This post will go through the process of writing a shell script to deploy a docker-compose file to a server.";var r=n(48173),a=n.n(r),l=n(76559),c=n(12115),d=n(15266),u=n(3104);function h(){let e="".concat(i," | Asher Falcon");return(0,c.useEffect)(()=>{document.title=e;let t=document.querySelector('meta[name="description"]');t&&t.setAttribute("content",o);let n=document.querySelector('meta[property="og:title"]');n||((n=document.createElement("meta")).setAttribute("property","og:title"),document.head.appendChild(n)),n.setAttribute("content",i);let s=document.querySelector('meta[property="og:description"]');s||((s=document.createElement("meta")).setAttribute("property","og:description"),document.head.appendChild(s)),s.setAttribute("content",o)},[e]),(0,s.jsx)("div",{className:"h-screen bg-ashwhite",children:(0,s.jsx)(l.PageTransition,{children:(0,s.jsxs)("div",{className:"pb-[20px]",children:[(0,s.jsxs)("div",{style:{paddingTop:"50px"},className:"relative flex justify-center items-center h-[50px]",children:[(0,s.jsx)("div",{className:"absolute left-0 flex items-center h-full ml-6",children:(0,s.jsx)(d.default,{defaultPath:"/blog"})}),(0,s.jsx)("span",{className:"text-xl",children:i})]}),(0,s.jsx)("div",{style:{paddingTop:"30px"},className:"flex justify-center items-center md:w-[70%] xl:w-[50%] w-[85%] mx-auto",children:(0,s.jsx)("div",{children:(0,s.jsx)("p",{children:o})})}),(0,s.jsxs)("div",{style:{paddingTop:"30px"},className:"flex flex-col justify-center items-center md:w-[70%] xl:w-[50%] w-[85%] mx-auto",children:[(0,s.jsxs)("p",{children:["TLDR, if you just want to check out the script and how to use it, you can find it ",(0,s.jsx)(a(),{className:"text-blue-500",href:"https://git.asherfalcon.com/asher/compose-deploy",target:"_blank",rel:"noopener noreferrer",children:"here"})]}),(0,s.jsx)("br",{}),(0,s.jsxs)("p",{children:["As I started deploying more and more services to my server using docker compose, I kept just copying the whole file, sshing into the server, deleting the file and creating a new one, pasting the content. As you can imagine, that got old fast. Realising I was losing an extra minute or two every time I wanted to re-deploy my ",(0,s.jsx)("b",{children:"docker-compose.yml"})," file, I created a simple git repository, and cloned it on both hosts. This meant I could simply push on my laptop and ssh into the server and run git pull, and I would never have to mess around with copying the whole file manually again. "]}),(0,s.jsx)("br",{}),(0,s.jsx)("p",{children:"Now I was still having to ssh in and stop all the containers, pull the repo and then start them again, and I though it would be nice if I could just do this from the terminal in the VSCode editor I used to edit the docker-compose.yml file, so I wrote a simple script which does all of it for me."}),(0,s.jsx)("br",{})]}),(0,s.jsx)(u.A,{code:'#!/bin/bash\ngit add .\ngit commit -m "updated docker-compose.yml"\ngit push\n\nssh -o "StrictHostKeyChecking=no" -i ssh.key $CD_USER@$CD_HOST << EOF\nsudo su\ncd $CD_PATH\ndocker compose down\ngit pull\ndocker compose up -d\nexit\nEOF\n',language:"bash"}),(0,s.jsxs)("div",{style:{paddingTop:"30px"},className:"flex flex-col justify-center items-center md:w-[70%] xl:w-[50%] w-[85%] mx-auto",children:[(0,s.jsx)("p",{children:"So what's going on here? Firstly we commit and push all the changed files to the repository, this means that the docker-compose.yml and any other files, for example config files for services you may be running, are now on the remote repository."}),(0,s.jsx)("br",{}),(0,s.jsx)("p",{children:"Next, it simply connects to the server via ssh, and runs the commands listed. Firstly, stopping the containers so that the docker-compose.yml and any other config files can be updated safely, then pulling the git repo to update the files. Finally restarting the docker compose services, and then exiting so the ssh session closes."}),(0,s.jsx)("br",{}),(0,s.jsxs)("p",{children:["Now to make the commit history not look like groundhog day, and to add some commit messages, we can use ",(0,s.jsx)(a(),{className:"text-blue-500",href:"https://github.com/charmbracelet/gum",target:"_blank",rel:"noopener noreferrer",children:"Gum"}),", a tool for easily making interactive bash scripts. It works by installing the application onto your system which can then be called inside your bash scripts to invoke user prompts, for example we can use the code below to get a commit message from the user in the terminal and store it as a variable."]}),(0,s.jsx)("br",{})]}),(0,s.jsx)(u.A,{code:'#!/bin/bash\nmessage=$(gum input --placeholder "Commit message")\ngit add .\ngit commit -m "${message}"\n',language:"bash"}),(0,s.jsxs)("div",{style:{paddingTop:"30px"},className:"flex flex-col justify-center items-center md:w-[70%] xl:w-[50%] w-[85%] mx-auto",children:[(0,s.jsx)("p",{children:"Finally, putting all the pieces together and adding a quick check to see if gum is installed, and trying to install it if not, we can arrive at the following script:"}),(0,s.jsx)("br",{})]}),(0,s.jsx)(u.A,{code:'#!/bin/bash\n\n# A script to redeploy this docker infrastructure using ssh\n\nif [ -f .env ]; then\n    source .env\nelse\n    echo ".env file not found. Please create it and set the necessary environment variables."\n    exit 1\nfi\n\ncheck_gum() {\n    if command -v gum &> /dev/null; then\n        return 0\n    else\n        echo "Gum not found, installing..."\n        return 1\n    fi\n}\n\ninstall_gum() {\n    if [[ "$OSTYPE" == "darwin"* ]]; then\n        /bin/bash -c "$(curl -fsSL \nhttps://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"\n        brew install gum\n    elif [[ -f /etc/os-release ]]; then\n        source /etc/os-release\n        if [[ $ID == "ubuntu" ]] || [[ $ID == "debian" ]]; then\n            sudo apt update\n            sudo apt install -y gum\n        elif [[ $ID == "fedora" ]] || [[ $ID == "centos" ]] || [[ $ID == "rhel" ]]; then\n            sudo dnf install -y gum\n        else\n            echo "Unsupported Linux distribution. Please install Gum \nmanually."\n            exit 1\n        fi\n    else\n        echo "Unsupported operating system. Please install Gum manually."\n        exit 1\n    fi\n}\n\n# Main script execution\nif ! check_gum; then\n    if ! install_gum; then\n        echo "Failed to install Gum. Please install it manually and run \nthe script again."\n        exit 1\n    fi\nfi\n\nmessage=$(gum input --placeholder "Commit message")\n\ngit add .\ngit commit -m "${message}"\ngit push\n\nssh -o "StrictHostKeyChecking=no" -i ssh.key $CD_USER@$CD_HOST << EOF\nsudo su\ncd $CD_PATH\ndocker compose down\ngit pull\ndocker compose up -d\nexit\nEOF',language:"bash"})]})})})}},15266:(e,t,n)=>{"use strict";n.d(t,{default:()=>a});var s=n(95155),i=n(34367),o=n(76046),r=n(12115);function a(e){let{defaultPath:t="/",className:n="",forceDefault:a=!1}=e,l=(0,o.useRouter)(),[c,d]=(0,r.useState)(null);(0,r.useEffect)(()=>{d(sessionStorage.getItem("previousUrl")),sessionStorage.setItem("previousUrl",window.location.href);let e=()=>{sessionStorage.removeItem("previousUrl"),sessionStorage.removeItem("backHistory")};return window.addEventListener("beforeunload",e),()=>{window.removeEventListener("beforeunload",e)}},[]);let u=(e,t)=>{let n=[...JSON.parse(sessionStorage.getItem("backHistory")||"[]"),{from:e,to:t,timestamp:Date.now()}].filter(e=>Date.now()-e.timestamp<1e4);if(n.length>=4){let e=n.slice(-4);if(4===e.length){let[t,n,s,i]=e;if(t.from===s.from&&t.to===s.to&&n.from===i.from&&n.to===i.to&&t.from===n.to&&n.from===t.to)return!0}}return n.filter(n=>n.from===e&&n.to===t).length>=2||(sessionStorage.setItem("backHistory",JSON.stringify(n)),!1)};return(0,s.jsx)("button",{onClick:()=>{if(a){l.push(t);return}let e=window.location.href,n=window.location.origin;if(c)try{if(new URL(c).origin!==n){l.push(t);return}if(u(e,c)){sessionStorage.removeItem("backHistory"),l.push(t);return}}catch(e){l.push(t);return}if(!c&&document.referrer)try{if(new URL(document.referrer).origin!==n){l.push(t);return}}catch(e){l.push(t);return}if(!c&&!document.referrer){l.push(t);return}l.back()},className:"flex items-center justify-center p-0 m-0 bg-transparent border-0 cursor-pointer ".concat(n),"aria-label":"Go back",children:(0,s.jsx)(i.K9R,{size:30})})}},76559:(e,t,n)=>{"use strict";n.d(t,{PageTransition:()=>r});var s=n(95155),i=n(18606);let o={hidden:{opacity:0},enter:{opacity:1},exit:{opacity:0}},r=e=>{let{children:t}=e;return(0,s.jsx)(i.P.div,{variants:o,initial:"hidden",animate:"enter",exit:"exit",transition:{type:"easeInOut",duration:.5},children:t})}},3104:(e,t,n)=>{"use strict";n.d(t,{A:()=>l,q:()=>c});var s=n(95155),i=n(12115),o=n(98867),r=n(23920),a=n(49216);function l(e){let{code:t,language:n="typescript"}=e,[l,c]=(0,i.useState)(!1),d=async()=>{try{await navigator.clipboard.writeText(t),c(!0),setTimeout(()=>c(!1),1500)}catch(e){console.error("Failed to copy:",e)}};return(0,s.jsx)("div",{className:"md:w-[70%] xl:w-[50%] w-[85%] mx-auto",children:(0,s.jsxs)("div",{className:"relative text-white",children:[(0,s.jsx)("div",{style:{position:"absolute",right:"10px",top:"10px"},children:(0,s.jsx)("button",{onClick:d,className:"p-2 rounded",children:l?(0,s.jsx)(o.A,{size:16,color:"#000000"}):(0,s.jsx)(r.A,{size:16,color:"#000000"})})}),(0,s.jsx)("center",{children:(0,s.jsx)(a.A,{language:n,customStyle:{backgroundColor:"transparent",border:"2px solid #000000",borderRadius:"8px",padding:"1rem",width:"100%",textAlign:"left"},children:t})})]})})}function c(e){let{code:t,language:n="typescript"}=e;return(0,s.jsx)(a.A,{language:n,PreTag:"span",CodeTag:"code",customStyle:{display:"inline",backgroundColor:"transparent",padding:0,margin:0,border:"none"},codeTagProps:{style:{display:"inline",padding:0,margin:0}},children:t})}}},e=>{var t=t=>e(e.s=t);e.O(0,[206,606,173,126,441,517,358],()=>t(77379)),_N_E=e.O()}]);